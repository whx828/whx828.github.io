<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport"
              content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="theme-color" content="#55bb8a">
        <title>xv6 学习记录</title>
<meta name="description" content="本文会不定期更新
">
<meta property="og:type" content="website">
<meta property="og:title" content="xv6 学习记录">
<meta property="og:description" content="本文会不定期更新
">
<meta name="twitter:title" content="xv6 学习记录">
<meta name="twitter:description" content="本文会不定期更新
">
<link rel="shortcut icon" href="path/to/favicon">
<meta property="og:url" content="http://whx828.github.io/s3/5">
    <meta property="twitter:url" content="http://whx828.github.io/s3/5">
<meta name="twitter:card" content="summary_large_image">
    <meta property="og:image" content="http://whx828.github.io/static/2023/MIT 6.S081 操作系统.jpg">
    <meta name="twitter:image" content="http://whx828.github.io/static/2023/MIT 6.S081 操作系统.jpg">
<link rel="icon" type="image/png" href="/favicon.ico">
        <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital@1&family=Raleway&family=Roboto+Mono&display=swap"
    rel="stylesheet">
<style>
    body {
        font-family: 'Open Sans', sans-serif;
        font-family: 'Raleway', sans-serif;
    }
</style><link rel="stylesheet" href="/static/zine.css">
        <link rel="alternate"
              type="application/atom+xml"
              title="whx's Blog RSS"
              href="/feed.xml">
        <style>
            :root {
                --primary-color: #55bb8a;
                --main-color: #111111;
                --link-color: #e97312;
                --secondary-color: #baccd9;
            }
        </style>
    </head>
    <body class="h-full bg-secondary">
        <div class="bg-primary text-main font-bold text-center z-0">
                <header class="p-8 md:p-10">
                    <div class="text-4xl lg:text-5xl">
                        <a href="/">whx's Blog</a>
                    </div>
                    <ul>
                        <li class="inline-block mt-6 mx-5 text-base hover:underline">
                                <a href="/about">About</a>
                            </li>
                        <li class="inline-block mt-6 mx-5 text-base hover:underline">
                                <a href="/feed.xml">RSS</a>
                            </li>
                        <li class="inline-block mt-6 mx-5 text-base hover:underline">
                                <a href="/static/resume.pdf">resume</a>
                            </li>
                        </ul>
                </header>
                <div class="w-full h-32 md:h-36 lg:h-44 xl:h-48 2xl:h-56"></div>
            </div>
            <main class="pb-10 -translate-y-32 md:-translate-y-32 lg:-translate-y-36 xl:-translate-y-44 2xl:-translate-y-56 mx-auto sm:max-w-scree-md md:max-w-screen-lg">
                <div class="p-4 pb-10 md:p-8 md:pb-14 mx-4 my-6 bg-white shadow-xl shadow-slate-700/10 ring-1 ring-gray-900/5">
        <div class="relative mx-2">
            <a class="before:block before:absolute before:-inset-1 before:-skew-x-6 before:bg-primary relative inline-block transition sm:hover:scale-110 duration-500"
               href="/s3">
                <div class="relative text-main px-4">2023</div>
            </a>
            <span class="ml-2 text-gray-700">/  第 ⁨4⁩ 篇</span>
        </div>
        <div class="mt-4 mb-8 w-full border-dashed border-t border-slate-300"></div>
        <div class="prose mx-auto">
            <h1 class="text-center">xv6 学习记录</h1>
            <div class="flex items-center justify-between text-gray-500">
                <span>2023-05-07</span>
                <a class="flex items-center px-2 py-1 !text-gray-500 rounded hover:bg-gray-200 hover:!no-underline"
           href="/@whx">
            <img class="!m-0 !p-1 w-7 h-7 rounded-full object-cover"
                 src="/static/avatar.png"
                 alt="avatar"
                 loading="lazy">
            <span>
                whx
                </span>
        </a>
    
            </div>
        </div>
        <article class="prose mx-auto my-12">
            <blockquote>
<p>本文会不定期更新</p>
</blockquote>
<p>最近（就这两天）在学习 MIT 的 <a href="https://pdos.csail.mit.edu/6.S081/2021/">6.S081</a>，打算补一补操作系统的课，毕竟我对操作系统还是很感兴趣的（<del>至于以前的坑嘛，笑</del>）。</p>
<p>大致翻了下 6.S081 的组成：</p>
<ul>
<li>课程视频：https://www.youtube.com/watch?v=L6YqHxYHa7A</li>
<li>课程教材：https://pdos.csail.mit.edu/6.828/2021/xv6/book-riscv-rev2.pdf</li>
<li>课程作业：https://pdos.csail.mit.edu/6.828/2021/schedule.html</li>
</ul>
<p>如果要把课程视频一一看过去太累，好在已经有好心人提供了课程视频的<a href="https://mit-public-courses-cn-translatio.gitbook.io/mit6-s081/">中文字幕翻译</a>，配合官方教材，可以在不看视频的情况下大致走一遍，对我而言够用了。</p>
<p>走完字幕后需要做一些 lab 练习才能巩固好所学，却没想到标注 easy 的 lab，其实也不是那么 easy。</p>
<h2 id="lab: xv6 and unix utilities" class="flex group">
<span>Lab: Xv6 and Unix utilities</span>
<a href="#lab: xv6 and unix utilities"
   class="ml-2 inline-flex items-center opacity-0 border-0 group-hover:opacity-100"
   aria-label="Anchor">
    <div class="w-6 h-6 text-slate-400 ring-1 ring-slate-900/5 rounded-md shadow-sm flex items-center justify-center hover:ring-slate-900/10 hover:shadow hover:text-slate-700">
        <svg width="12" height="12" fill="none" aria-hidden="true">
            <path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round">
            </path>
        </svg>
    </div>
</a>
</h2>
<h3 id="boot xv6 (easy)" class="flex group">
<span>Boot xv6 (easy)</span>
<a href="#boot xv6 (easy)"
   class="ml-2 inline-flex items-center opacity-0 border-0 group-hover:opacity-100"
   aria-label="Anchor">
    <div class="w-6 h-6 text-slate-400 ring-1 ring-slate-900/5 rounded-md shadow-sm flex items-center justify-center hover:ring-slate-900/10 hover:shadow hover:text-slate-700">
        <svg width="12" height="12" fill="none" aria-hidden="true">
            <path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round">
            </path>
        </svg>
    </div>
</a>
</h3>
<p>这个小 lab 是获取 xv6 的实验环境，做 xv6 实验所用的环境并不是 GitHub 上的那个仓库，而是需要你手动 clone 这个：<code>git clone git://g.csail.mit.edu/xv6-labs-2020</code>，之后你可以切到当前 lab 的分支：<code>git checkout util</code>，做什么实验就切到什么分支，非常方便。<br />
之后是最常用的命令：<code>make qemu</code>，顺利的话你就得到这么一堆玩意：</p>
<pre style="background-color:#fafafa;">
<span style="color:#61676c;">riscv64-unknown-elf-gcc -Wall -Werror -O -fno-omit-frame-pointer -ggdb -gdwarf-2 -DSOL_UTIL -MD -mcmodel=medany -ffreestanding -fno-common -nostdlib -mno-relax -I. -fno-stack-protector -fno-pie -no-pie   -c -o user/pingpong.o user/pingpong.c
</span><span style="color:#61676c;">riscv64-unknown-elf-ld -z max-page-size=4096 -N -e main -Ttext 0 -o user/_pingpong user/pingpong.o user/ulib.o user/usys.o user/printf.o user/umalloc.o
</span><span style="color:#61676c;">riscv64-unknown-elf-objdump -S user/_pingpong &gt; user/pingpong.asm
</span><span style="color:#61676c;">riscv64-unknown-elf-objdump -t user/_pingpong | sed &#39;1,/SYMBOL TABLE/d; s/ .* / /; /^$/d&#39; &gt; user/pingpong.sym
</span><span style="color:#61676c;">mkfs/mkfs fs.img README  user/xargstest.sh user/_cat user/_echo user/_forktest user/_grep user/_init user/_kill user/_ln user/_ls user/_mkdir user/_rm user/_sh user/_sleep user/_pingpong user/_primes user/_stressfs user/_usertests user/_grind user/_wc user/_zombie 
</span><span style="color:#61676c;">nmeta 46 (boot, super, log blocks 30 inode blocks 13, bitmap blocks 1) blocks 954 total 1000
</span><span style="color:#61676c;">balloc: first 727 blocks have been allocated
</span><span style="color:#61676c;">balloc: write bitmap block at sector 45
</span><span style="color:#61676c;">qemu-system-riscv64 -machine virt -bios none -kernel kernel/kernel -m 128M -smp 3 -nographic -drive file=fs.img,if=none,format=raw,id=x0 -device virtio-blk-device,drive=x0,bus=virtio-mmio-bus.0
</span><span style="color:#61676c;">
</span><span style="color:#61676c;">xv6 kernel is booting
</span><span style="color:#61676c;">
</span><span style="color:#61676c;">hart 1 starting
</span><span style="color:#61676c;">hart 2 starting
</span><span style="color:#61676c;">init: starting sh
</span><span style="color:#61676c;">$
</span></pre>
<p>才怪！在我的 MacBook 上卡住了，具体修改请看：</p>
<pre style="background-color:#fafafa;">
<span style="color:#61676c;">diff --git a/kernel/kernelvec.S b/kernel/kernelvec.S
</span><span style="color:#61676c;">index 3370ae5..3e9d3e9 100644
</span><span style="color:#c594c5;">--- a/kernel/kernelvec.S
</span><span style="color:#c594c5;">+++ b/kernel/kernelvec.S
</span><span style="color:#c594c5;">@@ -85,11 +85,6 @@ </span><span style="color:#399ee6;">kernelvec:
</span><span style="color:#61676c;">         // return to whatever we were doing in the kernel.
</span><span style="color:#61676c;">         sret
</span><span style="color:#61676c;"> 
</span><span style="color:#f07171;">-// help: if you hit these, an unexpected exception/interrupt happened in M-mode.
</span><span style="color:#f07171;">-// use `info registers` in the qemu monitor to get the relevant CSRs.
</span><span style="color:#f07171;">-unexpected_exc: j unexpected_exc
</span><span style="color:#f07171;">-unexpected_int: j unexpected_int
</span><span style="color:#f07171;">-
</span><span style="color:#61676c;">         #
</span><span style="color:#61676c;">         # machine-mode timer interrupt.
</span><span style="color:#61676c;">         #
</span><span style="color:#c594c5;">@@ -106,15 +101,6 @@ </span><span style="color:#399ee6;">timervec:
</span><span style="color:#61676c;">         sd a2, 8(a0)
</span><span style="color:#61676c;">         sd a3, 16(a0)
</span><span style="color:#61676c;"> 
</span><span style="color:#f07171;">-        csrr a1, mcause
</span><span style="color:#f07171;">-        // we should not get exceptions in M-mode. if we do, something went
</span><span style="color:#f07171;">-        // very wrong and we should explicitly jump to an infinite loop for the
</span><span style="color:#f07171;">-        // purpose.
</span><span style="color:#f07171;">-        bgez a1, unexpected_exc
</span><span style="color:#f07171;">-        li a2, (1&lt;&lt;63 | 7)
</span><span style="color:#f07171;">-        // likewise for any interrupts that are not machine timer interrupts.
</span><span style="color:#f07171;">-        bne a1, a2, unexpected_int
</span><span style="color:#f07171;">-
</span><span style="color:#61676c;">         # schedule the next timer interrupt
</span><span style="color:#61676c;">         # by adding interval to mtimecmp.
</span><span style="color:#61676c;">         ld a1, 32(a0) # CLINT_MTIMECMP(hart)
</span><span style="color:#c594c5;">@@ -124,7 +110,7 @@ </span><span style="color:#399ee6;">timervec:
</span><span style="color:#61676c;">         sd a3, 0(a1)
</span><span style="color:#61676c;"> 
</span><span style="color:#61676c;">         # raise a supervisor software interrupt.
</span><span style="color:#f07171;">-           li a1, 2
</span><span style="color:#86b300;">+       li a1, 2
</span><span style="color:#61676c;">         csrw sip, a1
</span><span style="color:#61676c;"> 
</span><span style="color:#61676c;">         ld a3, 16(a0)
</span><span style="color:#61676c;">diff --git a/kernel/riscv.h b/kernel/riscv.h
</span><span style="color:#61676c;">index 5f6c3d9..0aec003 100644
</span><span style="color:#c594c5;">--- a/kernel/riscv.h
</span><span style="color:#c594c5;">+++ b/kernel/riscv.h
</span><span style="color:#c594c5;">@@ -38,29 +38,6 @@ </span><span style="color:#399ee6;">w_mepc(uint64 x)
</span><span style="color:#61676c;">   asm volatile(&quot;csrw mepc, %0&quot; : : &quot;r&quot; (x));
</span><span style="color:#61676c;"> }
</span><span style="color:#61676c;">
</span><span style="color:#f07171;">-// physical memory protection CSRs
</span><span style="color:#f07171;">-#define PMP_R (1L &lt;&lt; 0)
</span><span style="color:#f07171;">-#define PMP_W (1L &lt;&lt; 1)
</span><span style="color:#f07171;">-#define PMP_X (1L &lt;&lt; 2)
</span><span style="color:#f07171;">-// naturally aligned power of two
</span><span style="color:#f07171;">-#define PMP_MATCH_NAPOT (3L &lt;&lt; 3)
</span><span style="color:#f07171;">-
</span><span style="color:#f07171;">-// we only implement accessing one PMP register
</span><span style="color:#f07171;">-
</span><span style="color:#f07171;">-// write to the first 8 PMP configuration registers
</span><span style="color:#f07171;">-static inline void
</span><span style="color:#f07171;">-w_pmpcfg0(uint64 x)
</span><span style="color:#f07171;">-{
</span><span style="color:#f07171;">-    asm volatile(&quot;csrw pmpcfg0, %0&quot; : : &quot;r&quot; (x));
</span><span style="color:#f07171;">-}
</span><span style="color:#f07171;">-
</span><span style="color:#f07171;">-// write to the address for PMP region 0
</span><span style="color:#f07171;">-static inline void
</span><span style="color:#f07171;">-w_pmpaddr0(uint64 x)
</span><span style="color:#f07171;">-{
</span><span style="color:#f07171;">-    asm volatile(&quot;csrw pmpaddr0, %0&quot; : : &quot;r&quot; (x));
</span><span style="color:#f07171;">-}
</span><span style="color:#f07171;">-
</span><span style="color:#61676c;"> // Supervisor Status Register, sstatus
</span><span style="color:#61676c;"> 
</span><span style="color:#61676c;"> #define SSTATUS_SPP (1L &lt;&lt; 8)  // Previous mode, 1=Supervisor, 0=User
</span><span style="color:#61676c;">diff --git a/kernel/start.c b/kernel/start.c
</span><span style="color:#61676c;">index 1c9fffc..4eb6c2d 100644
</span><span style="color:#c594c5;">--- a/kernel/start.c
</span><span style="color:#c594c5;">+++ b/kernel/start.c
</span><span style="color:#c594c5;">@@ -7,8 +7,6 @@
</span><span style="color:#61676c;"> void main();
</span><span style="color:#61676c;"> void timerinit();
</span><span style="color:#61676c;"> 
</span><span style="color:#f07171;">-static void pmpinit();
</span><span style="color:#f07171;">-
</span><span style="color:#61676c;"> // entry.S needs one stack per CPU.
</span><span style="color:#61676c;"> __attribute__ ((aligned (16))) char stack0[4096 * NCPU];
</span><span style="color:#61676c;"> 
</span><span style="color:#c594c5;">@@ -47,36 +45,10 @@ </span><span style="color:#399ee6;">start()
</span><span style="color:#61676c;">   int id = r_mhartid();
</span><span style="color:#61676c;">   w_tp(id);
</span><span style="color:#61676c;"> 
</span><span style="color:#f07171;">-  // allow access to all physical memory by S mode
</span><span style="color:#f07171;">-  pmpinit();
</span><span style="color:#f07171;">-
</span><span style="color:#61676c;">   // switch to supervisor mode and jump to main().
</span><span style="color:#61676c;">   asm volatile(&quot;mret&quot;);
</span><span style="color:#61676c;"> }
</span><span style="color:#61676c;">
</span><span style="color:#f07171;">-// configures the pmp registers trivially so we can boot. it is not permitted
</span><span style="color:#f07171;">-// to jump to S mode without having these configured as instruction fetch will
</span><span style="color:#f07171;">-// fail, however we do not actually use them for protection in xv6, so we just
</span><span style="color:#f07171;">-// need to put something trivial there.
</span><span style="color:#f07171;">-//
</span><span style="color:#f07171;">-// see section 3.6.1 &quot;Physical Memory Protection CSRs&quot; in the RISC-V privileged
</span><span style="color:#f07171;">-// specification (v20190608)
</span><span style="color:#f07171;">-//
</span><span style="color:#f07171;">-// &quot;If no PMP entry matches an M-mode access, the access succeeds. If no PMP
</span><span style="color:#f07171;">-// entry matches an S-mode or U-mode access, but at least one PMP entry is
</span><span style="color:#f07171;">-// implemented, the access fails.&quot; (3.6.1)
</span><span style="color:#f07171;">-static void
</span><span style="color:#f07171;">-pmpinit()
</span><span style="color:#f07171;">-{
</span><span style="color:#f07171;">-    // see figure 3.27 &quot;PMP address register format, RV64&quot; and table 3.10 &quot;NAPOT
</span><span style="color:#f07171;">-    // range encoding in PMP address and configuration registers&quot; in the RISC-V
</span><span style="color:#f07171;">-    // privileged specification
</span><span style="color:#f07171;">-    // we set the bits such that this matches any 56-bit physical address
</span><span style="color:#f07171;">-    w_pmpaddr0((~0ULL) &gt;&gt; 10);
</span><span style="color:#f07171;">-    // then we allow the access
</span><span style="color:#f07171;">-    w_pmpcfg0(PMP_R | PMP_W | PMP_X | PMP_MATCH_NAPOT);
</span><span style="color:#f07171;">-}
</span><span style="color:#f07171;">-
</span><span style="color:#61676c;"> // set up to receive timer interrupts in machine mode,
</span><span style="color:#61676c;"> // which arrive at timervec in kernelvec.S,
</span><span style="color:#61676c;"> // which turns them into software interrupts for
</span></pre>
<p>一顿修改后编译终于不再卡住了（觉得乱没关系，看后文就好），但是我调试的时候有个奇怪的问题——用 gdb 打印的时候会报：<code>dwarf2_find_location_expression: Corrupted DWARF expression.</code> 的错。<br />
最开始我以为这是 macOS 的问题，想换到 Ubuntu，但我的 Ubuntu 版本是 18.04，而 Xv6 在 Ubuntu 上的安装需要：<code>sudo apt-get install git build-essential gdb-multiarch qemu-system-misc gcc-riscv64-linux-gnu binutils-riscv64-linux-gnu</code>，其中 <code>qemu-system-misc</code> 需要 Ubuntu 的版本为 20 以上，所以我继续回来在 macOS 上想办法，最后在这个 <a href="https://github.com/mit-pdos/xv6-riscv/pull/129">PR</a> 中找到了答案：</p>
<p>修改 makefile：</p>
<pre style="background-color:#fafafa;">
<span style="color:#f07171;">- CFLAGS = -Wall -Werror -Wno-error=infinite-recursion -O -fno-omit-frame-pointer -ggdb
</span><span style="color:#86b300;">+ CFLAGS = -Wall -Werror -Wno-error=infinite-recursion -O -fno-omit-frame-pointer -ggdb -gdwarf-2
</span></pre>
<p>然后重新编译：</p>
<p><code>make clean &amp;&amp; make CPUS=1 qemu-gdb</code></p>
<p>问题解决！</p>
<blockquote>
<p>悲报：其实你不用像我这么改，因为我所遇到的问题似乎都被人解决了，只要你把 clone 的 <code>2020</code> 换成 <code>2021</code> 即可，悲伤，两天白玩。</p>
</blockquote>
<p>现在终于可以敲代码做 lab 了。</p>
<h3 id="sleep (easy)" class="flex group">
<span>sleep (easy)</span>
<a href="#sleep (easy)"
   class="ml-2 inline-flex items-center opacity-0 border-0 group-hover:opacity-100"
   aria-label="Anchor">
    <div class="w-6 h-6 text-slate-400 ring-1 ring-slate-900/5 rounded-md shadow-sm flex items-center justify-center hover:ring-slate-900/10 hover:shadow hover:text-slate-700">
        <svg width="12" height="12" fill="none" aria-hidden="true">
            <path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round">
            </path>
        </svg>
    </div>
</a>
</h3>
<p>Implement the UNIX program sleep for xv6; your sleep should pause for a user-specified number of ticks. A tick is a notion of time defined by the xv6 kernel, namely the time between two interrupts from the timer chip. Your solution should be in the file user/sleep.c.<br />
为 xv6 实现 UNIX 程序 sleep；您的 sleep 应暂停用户指定的 tick 数。tick 是由 xv6 内核定义的时间概念，即来自计时器芯片的两个中断之间的时间。您的解决方案应位于文件 user/sleep.c 中。</p>
<p>Some hints:</p>
<pre style="background-color:#fafafa;">
<span style="color:#61676c;">    Before you start coding, read Chapter 1 of the xv6 book.
</span><span style="color:#61676c;">    Look at some of the other programs in user/ (e.g., user/echo.c, user/grep.c, and user/rm.c) 
</span><span style="color:#61676c;">    to see how you can obtain the command-line arguments passed to a program.
</span><span style="color:#61676c;">    If the user forgets to pass an argument, sleep should print an error message.
</span><span style="color:#61676c;">    The command-line argument is passed as a string; you can convert it to an integer using atoi (see user/ulib.c).
</span><span style="color:#61676c;">    Use the system call sleep.
</span><span style="color:#61676c;">    See kernel/sysproc.c for the xv6 kernel code that implements the sleep system call (look for sys_sleep), 
</span><span style="color:#61676c;">    user/user.h for the C definition of sleep callable from a user program, 
</span><span style="color:#61676c;">    and user/usys.S for the assembler code that jumps from user code into the kernel for sleep.
</span><span style="color:#61676c;">    Make sure main calls exit() in order to exit your program.
</span><span style="color:#61676c;">    Add your sleep program to UPROGS in Makefile; once you&#39;ve done that, 
</span><span style="color:#61676c;">    make qemu will compile your program and you&#39;ll be able to run it from the xv6 shell.
</span><span style="color:#61676c;">    Look at Kernighan and Ritchie&#39;s book The C programming language (second edition) (K&amp;R) to learn about C.
</span></pre>
<p>这玩意还是相对简单：</p>
<pre style="background-color:#fafafa;">
<span style="color:#fa6e32;">#include </span><span style="color:#86b300;">&quot;kernel/types.h&quot;
</span><span style="color:#fa6e32;">#include </span><span style="color:#86b300;">&quot;kernel/stat.h&quot;
</span><span style="color:#fa6e32;">#include </span><span style="color:#86b300;">&quot;user/user.h&quot;
</span><span style="color:#61676c;">
</span><span style="color:#fa6e32;">int </span><span style="color:#f29718;">main</span><span style="color:#61676c;">(</span><span style="color:#fa6e32;">int </span><span style="color:#ff8f40;">argc</span><span style="color:#61676ccc;">, </span><span style="color:#fa6e32;">char </span><span style="color:#ed9366;">*</span><span style="color:#ff8f40;">argv</span><span style="color:#61676c;">[])
</span><span style="color:#61676c;">{
</span><span style="color:#61676c;">    </span><span style="color:#fa6e32;">if </span><span style="color:#61676c;">(argc </span><span style="color:#ed9366;">&lt; </span><span style="color:#ff8f40;">2</span><span style="color:#61676c;">)
</span><span style="color:#61676c;">    {
</span><span style="color:#61676c;">        </span><span style="color:#f07171;">fprintf</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">2</span><span style="color:#61676ccc;">, </span><span style="color:#86b300;">&quot;Usage: sleep x/10th of a second...</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        </span><span style="color:#f07171;">exit</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">    }
</span><span style="color:#61676c;">
</span><span style="color:#61676c;">    </span><span style="color:#f29718;">sleep</span><span style="color:#61676c;">(</span><span style="color:#f07171;">atoi</span><span style="color:#61676c;">(argv[</span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">]))</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">
</span><span style="color:#61676c;">    </span><span style="color:#f07171;">exit</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">}
</span></pre>
<p>测试一下：</p>
<pre style="background-color:#fafafa;">
<span style="color:#61676c;">./grade-lab-util sleep
</span><span style="color:#61676c;">make: `kernel/kernel&#39; is up to date.
</span><span style="color:#61676c;">== Test sleep, no arguments == sleep, no arguments: OK (1.3s) 
</span><span style="color:#61676c;">== Test sleep, returns == sleep, returns: OK (1.1s) 
</span><span style="color:#61676c;">== Test sleep, makes syscall == sleep, makes syscall: OK (0.8s) 
</span></pre>
<p>搞定。</p>
<h3 id="pingpong (easy)" class="flex group">
<span>pingpong (easy)</span>
<a href="#pingpong (easy)"
   class="ml-2 inline-flex items-center opacity-0 border-0 group-hover:opacity-100"
   aria-label="Anchor">
    <div class="w-6 h-6 text-slate-400 ring-1 ring-slate-900/5 rounded-md shadow-sm flex items-center justify-center hover:ring-slate-900/10 hover:shadow hover:text-slate-700">
        <svg width="12" height="12" fill="none" aria-hidden="true">
            <path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round">
            </path>
        </svg>
    </div>
</a>
</h3>
<p>Write a program that uses UNIX system calls to ‘ping-pong’ a byte between two processes over a pair of pipes, one for each direction. The parent should send a byte to the child; the child should print “&lt;pid&gt;: received ping”, where &lt;pid&gt; is its process ID, write the byte on the pipe to the parent, and exit; the parent should read the byte from the child, print “&lt;pid&gt;: received pong”, and exit. Your solution should be in the file user/pingpong.c.<br />
编写一个程序，该程序使用 UNIX 系统调用，通过一对管道在两个进程之间“乒乓”一个字节，每个方向一个。父进程应该向子进程发送一个字节；子进程应打印“&lt;pid&gt;: received ping”，&lt;pid&gt;表示其进程ID，后将管道上的字节写入父进程，然后退出；父进程应从子进程的 pipe 中读取字节，打印“&lt;pid&gt;: received ping”，然后退出。您的解决方案应位于文件 user/pingpong.c 中。</p>
<p>Some hints:</p>
<pre style="background-color:#fafafa;">
<span style="color:#61676c;">    Use pipe to create a pipe.
</span><span style="color:#61676c;">    Use fork to create a child.
</span><span style="color:#61676c;">    Use read to read from the pipe, and write to write to the pipe.
</span><span style="color:#61676c;">    Use getpid to find the process ID of the calling process.
</span><span style="color:#61676c;">    Add the program to UPROGS in Makefile.
</span><span style="color:#61676c;">    User programs on xv6 have a limited set of library functions available to them. 
</span><span style="color:#61676c;">    You can see the list in user/user.h; 
</span><span style="color:#61676c;">    the source (other than for system calls) is in user/ulib.c, user/printf.c, and user/umalloc.c.
</span></pre>
<p>这个就是并不 easy 的 easy lab 了，最开始的时候怎么都有问题，不是交错打印就是提前退出，上网查找，主流的解决方案是用两个 pipe：</p>
<pre style="background-color:#fafafa;">
<span style="color:#fa6e32;">#include </span><span style="color:#86b300;">&quot;kernel/types.h&quot;
</span><span style="color:#fa6e32;">#include </span><span style="color:#86b300;">&quot;user/user.h&quot;
</span><span style="color:#61676c;">
</span><span style="color:#fa6e32;">#define </span><span style="color:#399ee6;">READEND </span><span style="color:#ff8f40;">0
</span><span style="color:#fa6e32;">#define </span><span style="color:#399ee6;">WRITEEND </span><span style="color:#ff8f40;">1
</span><span style="color:#61676c;">
</span><span style="color:#fa6e32;">int
</span><span style="color:#f29718;">main</span><span style="color:#61676c;">(</span><span style="color:#fa6e32;">int </span><span style="color:#ff8f40;">argc</span><span style="color:#61676ccc;">, </span><span style="color:#fa6e32;">char </span><span style="color:#ed9366;">*</span><span style="color:#ff8f40;">argv</span><span style="color:#61676c;">[]) {
</span><span style="color:#61676c;">	</span><span style="color:#fa6e32;">int</span><span style="color:#61676c;"> p1[</span><span style="color:#ff8f40;">2</span><span style="color:#61676c;">]</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">	</span><span style="color:#fa6e32;">int</span><span style="color:#61676c;"> p2[</span><span style="color:#ff8f40;">2</span><span style="color:#61676c;">]</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">	</span><span style="color:#fa6e32;">int</span><span style="color:#61676c;"> pid</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">	</span><span style="color:#fa6e32;">char</span><span style="color:#61676c;"> buf[</span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">]</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">
</span><span style="color:#61676c;">	</span><span style="color:#f29718;">pipe</span><span style="color:#61676c;">(p1)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">	</span><span style="color:#f29718;">pipe</span><span style="color:#61676c;">(p2)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">
</span><span style="color:#61676c;">	pid </span><span style="color:#ed9366;">= </span><span style="color:#f29718;">fork</span><span style="color:#61676c;">()</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">
</span><span style="color:#61676c;">	</span><span style="color:#fa6e32;">if </span><span style="color:#61676c;">(pid </span><span style="color:#ed9366;">&lt; </span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">)
</span><span style="color:#61676c;">		</span><span style="color:#f07171;">exit</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">	</span><span style="color:#fa6e32;">else if </span><span style="color:#61676c;">(pid </span><span style="color:#ed9366;">== </span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">) {
</span><span style="color:#61676c;">		</span><span style="color:#f29718;">close</span><span style="color:#61676c;">(p1[WRITEEND])</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">		</span><span style="color:#f29718;">close</span><span style="color:#61676c;">(p2[READEND])</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">		</span><span style="color:#f29718;">read</span><span style="color:#61676c;">(p1[READEND]</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> buf</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">		</span><span style="color:#f07171;">printf</span><span style="color:#61676c;">(</span><span style="color:#86b300;">&quot;</span><span style="color:#ff8f40;">%d</span><span style="color:#86b300;">: received ping</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span style="color:#61676ccc;">, </span><span style="color:#f29718;">getpid</span><span style="color:#61676c;">())</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">		</span><span style="color:#f29718;">write</span><span style="color:#61676c;">(p2[WRITEEND]</span><span style="color:#61676ccc;">, </span><span style="color:#86b300;">&quot; &quot;</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">		</span><span style="color:#f29718;">close</span><span style="color:#61676c;">(p1[READEND])</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">		</span><span style="color:#f29718;">close</span><span style="color:#61676c;">(p2[WRITEEND])</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">		</span><span style="color:#f07171;">exit</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">	} </span><span style="color:#fa6e32;">else </span><span style="color:#61676c;">{
</span><span style="color:#61676c;">		</span><span style="color:#f29718;">close</span><span style="color:#61676c;">(p1[READEND])</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">		</span><span style="color:#f29718;">close</span><span style="color:#61676c;">(p2[WRITEEND])</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">		</span><span style="color:#f29718;">write</span><span style="color:#61676c;">(p1[WRITEEND]</span><span style="color:#61676ccc;">, </span><span style="color:#86b300;">&quot; &quot;</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">		</span><span style="color:#f29718;">read</span><span style="color:#61676c;">(p2[READEND]</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> buf</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">		</span><span style="color:#f07171;">printf</span><span style="color:#61676c;">(</span><span style="color:#86b300;">&quot;</span><span style="color:#ff8f40;">%d</span><span style="color:#86b300;">: received pong</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span style="color:#61676ccc;">, </span><span style="color:#f29718;">getpid</span><span style="color:#61676c;">())</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">		</span><span style="color:#f29718;">close</span><span style="color:#61676c;">(p1[WRITEEND])</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">		</span><span style="color:#f29718;">close</span><span style="color:#61676c;">(p2[READEND])</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">		</span><span style="color:#f07171;">exit</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">	}
</span><span style="color:#61676c;">}
</span></pre>
<p>这个 lab 如果需要提示，就是用两个 pipe，一个接一个发（没有化很遗憾，对不起马老师）；<br />
但我最开始写的时候想用一个 pipe 就解决问题，所以更接近这个答案：</p>
<pre style="background-color:#fafafa;">
<span style="color:#fa6e32;">#include </span><span style="color:#86b300;">&quot;kernel/types.h&quot;
</span><span style="color:#fa6e32;">#include </span><span style="color:#86b300;">&quot;kernel/stat.h&quot;
</span><span style="color:#fa6e32;">#include </span><span style="color:#86b300;">&quot;user/user.h&quot;
</span><span style="color:#61676c;">
</span><span style="color:#fa6e32;">int </span><span style="color:#f29718;">main</span><span style="color:#61676c;">(</span><span style="color:#fa6e32;">int </span><span style="color:#ff8f40;">argc</span><span style="color:#61676ccc;">, </span><span style="color:#fa6e32;">char </span><span style="color:#ed9366;">*</span><span style="color:#ff8f40;">argv</span><span style="color:#61676c;">[]) {
</span><span style="color:#61676c;">    </span><span style="color:#fa6e32;">int</span><span style="color:#61676c;"> p[</span><span style="color:#ff8f40;">2</span><span style="color:#61676c;">]</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">    </span><span style="color:#fa6e32;">char</span><span style="color:#61676c;"> buf[</span><span style="color:#ff8f40;">2</span><span style="color:#61676c;">]</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">    </span><span style="color:#fa6e32;">char </span><span style="color:#ed9366;">*</span><span style="color:#61676c;">parmsg </span><span style="color:#ed9366;">= </span><span style="color:#86b300;">&quot;a&quot;</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">    </span><span style="color:#fa6e32;">char </span><span style="color:#ed9366;">*</span><span style="color:#61676c;">chimsg </span><span style="color:#ed9366;">= </span><span style="color:#86b300;">&quot;b&quot;</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">    </span><span style="color:#f29718;">pipe</span><span style="color:#61676c;">(p)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">
</span><span style="color:#61676c;">    </span><span style="color:#fa6e32;">if </span><span style="color:#61676c;">(</span><span style="color:#f29718;">fork</span><span style="color:#61676c;">() </span><span style="color:#ed9366;">== </span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">){
</span><span style="color:#61676c;">        </span><span style="color:#fa6e32;">if </span><span style="color:#61676c;">(</span><span style="color:#f29718;">read</span><span style="color:#61676c;">(p[</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">]</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> buf</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">) </span><span style="color:#ed9366;">!= </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">){
</span><span style="color:#61676c;">            </span><span style="color:#f07171;">fprintf</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">2</span><span style="color:#61676ccc;">, </span><span style="color:#86b300;">&quot;Can&#39;t read from parent!</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">            </span><span style="color:#f07171;">exit</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        }
</span><span style="color:#61676c;">        </span><span style="color:#f07171;">printf</span><span style="color:#61676c;">(</span><span style="color:#86b300;">&quot;child receive: </span><span style="color:#ff8f40;">%c</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> buf[</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">])</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        </span><span style="color:#f29718;">close</span><span style="color:#61676c;">(p[</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">])</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">
</span><span style="color:#61676c;">        </span><span style="color:#f07171;">printf</span><span style="color:#61676c;">(</span><span style="color:#86b300;">&quot;</span><span style="color:#ff8f40;">%d</span><span style="color:#86b300;">: received ping</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span style="color:#61676ccc;">, </span><span style="color:#f29718;">getpid</span><span style="color:#61676c;">())</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        </span><span style="color:#fa6e32;">if </span><span style="color:#61676c;">(</span><span style="color:#f29718;">write</span><span style="color:#61676c;">(p[</span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">]</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> chimsg</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">) </span><span style="color:#ed9366;">!= </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">){
</span><span style="color:#61676c;">            </span><span style="color:#f07171;">fprintf</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">2</span><span style="color:#61676ccc;">, </span><span style="color:#86b300;">&quot;Can&#39;t write to parent!&quot;</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        }
</span><span style="color:#61676c;">        </span><span style="color:#f29718;">close</span><span style="color:#61676c;">(p[</span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">])</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        
</span><span style="color:#61676c;">        </span><span style="color:#f07171;">exit</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">    } </span><span style="color:#fa6e32;">else </span><span style="color:#61676c;">{
</span><span style="color:#61676c;">        </span><span style="color:#fa6e32;">if </span><span style="color:#61676c;">(</span><span style="color:#f29718;">write</span><span style="color:#61676c;">(p[</span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">]</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> parmsg</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">) </span><span style="color:#ed9366;">!= </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">){
</span><span style="color:#61676c;">            </span><span style="color:#f07171;">fprintf</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">2</span><span style="color:#61676ccc;">, </span><span style="color:#86b300;">&quot;Can&#39;t write to child!</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">            </span><span style="color:#f07171;">exit</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        }
</span><span style="color:#61676c;">        </span><span style="color:#f29718;">close</span><span style="color:#61676c;">(p[</span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">])</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">
</span><span style="color:#61676c;">        </span><span style="color:#f29718;">wait</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">
</span><span style="color:#61676c;">        </span><span style="color:#fa6e32;">if </span><span style="color:#61676c;">(</span><span style="color:#f29718;">read</span><span style="color:#61676c;">(p[</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">]</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> buf</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">) </span><span style="color:#ed9366;">!= </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">){
</span><span style="color:#61676c;">            </span><span style="color:#f07171;">fprintf</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">2</span><span style="color:#61676ccc;">, </span><span style="color:#86b300;">&quot;Can&#39;t read from child!&quot;</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">            </span><span style="color:#f07171;">exit</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        }
</span><span style="color:#61676c;">        </span><span style="color:#f07171;">printf</span><span style="color:#61676c;">(</span><span style="color:#86b300;">&quot;parent receive: </span><span style="color:#ff8f40;">%c</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> buf[</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">])</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        </span><span style="color:#f29718;">close</span><span style="color:#61676c;">(p[</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">])</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        </span><span style="color:#f07171;">printf</span><span style="color:#61676c;">(</span><span style="color:#86b300;">&quot;</span><span style="color:#ff8f40;">%d</span><span style="color:#86b300;">: received pong</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span style="color:#61676ccc;">, </span><span style="color:#f29718;">getpid</span><span style="color:#61676c;">())</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">
</span><span style="color:#61676c;">        </span><span style="color:#f07171;">exit</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">    }
</span><span style="color:#61676c;">}
</span></pre>
<p>如果我一上来就写成这样也不会说这道题难了，我写的是这样的：</p>
<pre style="background-color:#fafafa;">
<span style="color:#fa6e32;">#include </span><span style="color:#86b300;">&quot;kernel/types.h&quot;
</span><span style="color:#fa6e32;">#include </span><span style="color:#86b300;">&quot;kernel/stat.h&quot;
</span><span style="color:#fa6e32;">#include </span><span style="color:#86b300;">&quot;user/user.h&quot;
</span><span style="color:#61676c;">
</span><span style="color:#fa6e32;">int </span><span style="color:#f29718;">main</span><span style="color:#61676c;">(</span><span style="color:#fa6e32;">int </span><span style="color:#ff8f40;">argc</span><span style="color:#61676ccc;">, </span><span style="color:#fa6e32;">char </span><span style="color:#ed9366;">*</span><span style="color:#ff8f40;">argv</span><span style="color:#61676c;">[]) {
</span><span style="color:#61676c;">    </span><span style="color:#fa6e32;">int</span><span style="color:#61676c;"> p[</span><span style="color:#ff8f40;">2</span><span style="color:#61676c;">]</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">    </span><span style="color:#fa6e32;">char</span><span style="color:#61676c;"> buf[</span><span style="color:#ff8f40;">2</span><span style="color:#61676c;">]</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">    </span><span style="color:#fa6e32;">char </span><span style="color:#ed9366;">*</span><span style="color:#61676c;">parmsg </span><span style="color:#ed9366;">= </span><span style="color:#86b300;">&quot;a&quot;</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">    </span><span style="color:#fa6e32;">char </span><span style="color:#ed9366;">*</span><span style="color:#61676c;">chimsg </span><span style="color:#ed9366;">= </span><span style="color:#86b300;">&quot;b&quot;</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">    </span><span style="color:#f29718;">pipe</span><span style="color:#61676c;">(p)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">
</span><span style="color:#61676c;">    </span><span style="color:#fa6e32;">if </span><span style="color:#61676c;">(</span><span style="color:#f29718;">fork</span><span style="color:#61676c;">() </span><span style="color:#ed9366;">== </span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">){
</span><span style="color:#61676c;">        </span><span style="color:#fa6e32;">if </span><span style="color:#61676c;">(</span><span style="color:#f29718;">read</span><span style="color:#61676c;">(p[</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">]</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> buf</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">) </span><span style="color:#ed9366;">!= </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">){
</span><span style="color:#61676c;">            </span><span style="color:#f07171;">fprintf</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">2</span><span style="color:#61676ccc;">, </span><span style="color:#86b300;">&quot;Can&#39;t read from parent!</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">            </span><span style="color:#f07171;">exit</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        }
</span><span style="color:#61676c;">        </span><span style="color:#f07171;">printf</span><span style="color:#61676c;">(</span><span style="color:#86b300;">&quot;child receive: </span><span style="color:#ff8f40;">%c</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> buf[</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">])</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        </span><span style="color:#f29718;">close</span><span style="color:#61676c;">(p[</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">])</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">
</span><span style="color:#61676c;">        </span><span style="color:#f07171;">printf</span><span style="color:#61676c;">(</span><span style="color:#86b300;">&quot;</span><span style="color:#ff8f40;">%d</span><span style="color:#86b300;">: received ping</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span style="color:#61676ccc;">, </span><span style="color:#f29718;">getpid</span><span style="color:#61676c;">())</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        </span><span style="color:#fa6e32;">if </span><span style="color:#61676c;">(</span><span style="color:#f29718;">write</span><span style="color:#61676c;">(p[</span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">]</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> chimsg</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">) </span><span style="color:#ed9366;">!= </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">){
</span><span style="color:#61676c;">            </span><span style="color:#f07171;">fprintf</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">2</span><span style="color:#61676ccc;">, </span><span style="color:#86b300;">&quot;Can&#39;t write to parent!&quot;</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        }
</span><span style="color:#61676c;">        </span><span style="color:#f29718;">close</span><span style="color:#61676c;">(p[</span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">])</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        
</span><span style="color:#61676c;">        </span><span style="color:#f07171;">exit</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">    } </span><span style="color:#fa6e32;">else </span><span style="color:#61676c;">{
</span><span style="color:#61676c;">        </span><span style="color:#fa6e32;">if </span><span style="color:#61676c;">(</span><span style="color:#f29718;">write</span><span style="color:#61676c;">(p[</span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">]</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> parmsg</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">) </span><span style="color:#ed9366;">!= </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">){
</span><span style="color:#61676c;">            </span><span style="color:#f07171;">fprintf</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">2</span><span style="color:#61676ccc;">, </span><span style="color:#86b300;">&quot;Can&#39;t write to child!</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">            </span><span style="color:#f07171;">exit</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        }
</span><span style="color:#61676c;">        </span><span style="color:#f29718;">close</span><span style="color:#61676c;">(p[</span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">])</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">
</span><span style="color:#61676c;">        </span><span style="color:#fa6e32;">if </span><span style="color:#61676c;">(</span><span style="color:#f29718;">read</span><span style="color:#61676c;">(p[</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">]</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> buf</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">) </span><span style="color:#ed9366;">!= </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">){
</span><span style="color:#61676c;">            </span><span style="color:#f07171;">fprintf</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">2</span><span style="color:#61676ccc;">, </span><span style="color:#86b300;">&quot;Can&#39;t read from child!&quot;</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">            </span><span style="color:#f07171;">exit</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        }
</span><span style="color:#61676c;">        </span><span style="color:#f07171;">printf</span><span style="color:#61676c;">(</span><span style="color:#86b300;">&quot;parent receive: </span><span style="color:#ff8f40;">%c</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> buf[</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">])</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        </span><span style="color:#f29718;">close</span><span style="color:#61676c;">(p[</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">])</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        </span><span style="color:#f07171;">printf</span><span style="color:#61676c;">(</span><span style="color:#86b300;">&quot;</span><span style="color:#ff8f40;">%d</span><span style="color:#86b300;">: received pong</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span style="color:#61676ccc;">, </span><span style="color:#f29718;">getpid</span><span style="color:#61676c;">())</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">
</span><span style="color:#61676c;">        </span><span style="color:#f29718;">wait</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">)
</span><span style="color:#61676c;">        </span><span style="color:#f07171;">exit</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">    }
</span><span style="color:#61676c;">}
</span></pre>
<p>区别在于 <code>wait(0)</code> 的位置。我的版本，输出一般是这样的：</p>
<pre style="background-color:#fafafa;">
<span style="color:#61676c;">$ pingpong
</span><span style="color:#61676c;">parent receive: a
</span><span style="color:#61676c;">3: received pong
</span></pre>
<p>代码会直接阻塞住，为了找出 Bug，我去掉了 <code>wait(0)</code>，输出开始有一些变化了：</p>
<pre style="background-color:#fafafa;">
<span style="color:#fa6e32;">#include </span><span style="color:#86b300;">&quot;kernel/types.h&quot;
</span><span style="color:#fa6e32;">#include </span><span style="color:#86b300;">&quot;kernel/stat.h&quot;
</span><span style="color:#fa6e32;">#include </span><span style="color:#86b300;">&quot;user/user.h&quot;
</span><span style="color:#61676c;">
</span><span style="color:#fa6e32;">int </span><span style="color:#f29718;">main</span><span style="color:#61676c;">(</span><span style="color:#fa6e32;">int </span><span style="color:#ff8f40;">argc</span><span style="color:#61676ccc;">, </span><span style="color:#fa6e32;">char </span><span style="color:#ed9366;">*</span><span style="color:#ff8f40;">argv</span><span style="color:#61676c;">[]){
</span><span style="color:#61676c;">    </span><span style="color:#fa6e32;">int</span><span style="color:#61676c;"> p[</span><span style="color:#ff8f40;">2</span><span style="color:#61676c;">]</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">    </span><span style="color:#fa6e32;">char</span><span style="color:#61676c;"> buf[</span><span style="color:#ff8f40;">2</span><span style="color:#61676c;">]</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">    </span><span style="color:#fa6e32;">char </span><span style="color:#ed9366;">*</span><span style="color:#61676c;">parmsg </span><span style="color:#ed9366;">= </span><span style="color:#86b300;">&quot;a&quot;</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">    </span><span style="color:#fa6e32;">char </span><span style="color:#ed9366;">*</span><span style="color:#61676c;">chimsg </span><span style="color:#ed9366;">= </span><span style="color:#86b300;">&quot;b&quot;</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">    </span><span style="color:#f29718;">pipe</span><span style="color:#61676c;">(p)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">
</span><span style="color:#61676c;">    </span><span style="color:#fa6e32;">if </span><span style="color:#61676c;">(</span><span style="color:#f29718;">fork</span><span style="color:#61676c;">() </span><span style="color:#ed9366;">== </span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">){
</span><span style="color:#61676c;">        </span><span style="color:#fa6e32;">if </span><span style="color:#61676c;">(</span><span style="color:#f29718;">read</span><span style="color:#61676c;">(p[</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">]</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> buf</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">) </span><span style="color:#ed9366;">!= </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">){
</span><span style="color:#61676c;">            </span><span style="color:#f07171;">fprintf</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">2</span><span style="color:#61676ccc;">, </span><span style="color:#86b300;">&quot;Can&#39;t read from parent!</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">            </span><span style="color:#f07171;">exit</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        }
</span><span style="color:#61676c;">        </span><span style="color:#f07171;">printf</span><span style="color:#61676c;">(</span><span style="color:#86b300;">&quot;child receive: </span><span style="color:#ff8f40;">%c</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> buf[</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">])</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        </span><span style="color:#f29718;">close</span><span style="color:#61676c;">(p[</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">])</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">
</span><span style="color:#61676c;">        </span><span style="color:#f07171;">printf</span><span style="color:#61676c;">(</span><span style="color:#86b300;">&quot;</span><span style="color:#ff8f40;">%d</span><span style="color:#86b300;">: received ping</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span style="color:#61676ccc;">, </span><span style="color:#f29718;">getpid</span><span style="color:#61676c;">())</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        </span><span style="color:#fa6e32;">if </span><span style="color:#61676c;">(</span><span style="color:#f29718;">write</span><span style="color:#61676c;">(p[</span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">]</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> chimsg</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">) </span><span style="color:#ed9366;">!= </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">){
</span><span style="color:#61676c;">            </span><span style="color:#f07171;">fprintf</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">2</span><span style="color:#61676ccc;">, </span><span style="color:#86b300;">&quot;Can&#39;t write to parent!&quot;</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        }
</span><span style="color:#61676c;">        </span><span style="color:#f29718;">close</span><span style="color:#61676c;">(p[</span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">])</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        
</span><span style="color:#61676c;">        </span><span style="color:#f07171;">exit</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">    } </span><span style="color:#fa6e32;">else </span><span style="color:#61676c;">{
</span><span style="color:#61676c;">        </span><span style="color:#fa6e32;">if </span><span style="color:#61676c;">(</span><span style="color:#f29718;">write</span><span style="color:#61676c;">(p[</span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">]</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> parmsg</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">) </span><span style="color:#ed9366;">!= </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">){
</span><span style="color:#61676c;">            </span><span style="color:#f07171;">fprintf</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">2</span><span style="color:#61676ccc;">, </span><span style="color:#86b300;">&quot;Can&#39;t write to child!</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">            </span><span style="color:#f07171;">exit</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        }
</span><span style="color:#61676c;">        </span><span style="color:#f29718;">close</span><span style="color:#61676c;">(p[</span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">])</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">
</span><span style="color:#61676c;">        </span><span style="color:#fa6e32;">if </span><span style="color:#61676c;">(</span><span style="color:#f29718;">read</span><span style="color:#61676c;">(p[</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">]</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> buf</span><span style="color:#61676ccc;">, </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">) </span><span style="color:#ed9366;">!= </span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">){
</span><span style="color:#61676c;">            </span><span style="color:#f07171;">fprintf</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">2</span><span style="color:#61676ccc;">, </span><span style="color:#86b300;">&quot;Can&#39;t read from child!&quot;</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">            </span><span style="color:#f07171;">exit</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">1</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        }
</span><span style="color:#61676c;">        </span><span style="color:#f07171;">printf</span><span style="color:#61676c;">(</span><span style="color:#86b300;">&quot;parent receive: </span><span style="color:#ff8f40;">%c</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> buf[</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">])</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        </span><span style="color:#f29718;">close</span><span style="color:#61676c;">(p[</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">])</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">        </span><span style="color:#f07171;">printf</span><span style="color:#61676c;">(</span><span style="color:#86b300;">&quot;</span><span style="color:#ff8f40;">%d</span><span style="color:#86b300;">: received pong</span><span style="color:#4cbf99;">\n</span><span style="color:#86b300;">&quot;</span><span style="color:#61676ccc;">, </span><span style="color:#f29718;">getpid</span><span style="color:#61676c;">())</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">
</span><span style="color:#61676c;">        </span><span style="color:#f07171;">exit</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">0</span><span style="color:#61676c;">)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">    }
</span><span style="color:#61676c;">}
</span></pre>
<p>输出是这样的：</p>
<pre style="background-color:#fafafa;">
<span style="color:#61676c;">$ pingpong
</span><span style="color:#61676c;">parent receive: a
</span><span style="color:#61676c;">3: received pong
</span><span style="color:#61676c;">$ pingpong
</span><span style="color:#61676c;">parent receive: a
</span><span style="color:#61676c;">5: received pong
</span><span style="color:#61676c;">$ pingpong
</span><span style="color:#61676c;">parent receive: a
</span><span style="color:#61676c;">7: received pong
</span><span style="color:#61676c;">$ pingpong
</span><span style="color:#61676c;">parent receive: a
</span><span style="color:#61676c;">9: received pong
</span><span style="color:#61676c;">$ pingpong
</span><span style="color:#61676c;">parent receive: a
</span><span style="color:#61676c;">11: received pong
</span><span style="color:#61676c;">$ pingpong
</span><span style="color:#61676c;">parent receive: a
</span><span style="color:#61676c;">13: received pong
</span><span style="color:#61676c;">$ pingpong
</span><span style="color:#61676c;">child receive: a
</span><span style="color:#61676c;">16: received ping
</span><span style="color:#61676c;">parent receive: b
</span><span style="color:#61676c;">15: received pong
</span><span style="color:#61676c;">$ QEMU: Terminated
</span></pre>
<p>可以看到最后还是正常运行了一次，其余都是错误输出，为什么会这样呢？关键在 pipe 上。</p>
<p>在 xv6 中通过系统调用 <code>pipe(int p[])</code> 可以创建一个匿名管道，然后将对应管道读端的文件描述符放入 <code>p[0]</code>，对应管道写端的文件描述符放入 <code>p[1]</code>。<code>p[0]</code> 是具有只读属性的文件描述符，<code>p[1]</code> 是具有只写属性的文件描述符。</p>
<p>匿名管道底下对应的文件没有文件名，因此只能被有亲缘的进程打开。实际情形如下图所示</p>
<p><img src="../../static/2023/pipe.svg" alt="" loading="lazy">
子进程与父进程之间通过匿名管道通信</p>
<p>为什么子进程不需要等待父进程的写入先完成？<br />
答案是，在管道上的 <code>read</code> 是阻塞的。在没有数据可读时，在管道上的 <code>read</code> 会一直阻塞，直到要么有新的数据被写入，或者管道的所有写端都被关闭。在后者的情况下，<code>read</code> 会返回 0。也正因为这个特性，所有不需要写入数据的子进程，都应该主动关闭掉管道的写端。</p>
<p>在我的程序中出现了这样的输出：</p>
<pre style="background-color:#fafafa;">
<span style="color:#61676c;">parent receive: a
</span><span style="color:#61676c;">3: received pong
</span></pre>
<p>一个可能是：<code>else</code> 分支也就是父进程的 <code>write</code> 被同在 <code>else</code> 分支的 <code>read</code>（也就是它自己的）消耗掉了，所以 <code>parent receive</code> 才是 <code>a</code> 而不是 <code>b</code>。<br />
<code>write</code> 操作是在 <code>read</code> 操作之前完成的，因此在 <code>read</code> 操作之前，数据已经被写入管道中，且管道中的数据已经准备好被读取。因此，可以保证在 <code>read</code> 操作中能够读取到 <code>write</code> 操作写入的数据。<br />
正常的程序，父进程写入管道的数据应该被子进程消耗掉才对。如果不加 <code>wait(0)</code>：</p>
<ul>
<li>运气好，就像最后一次输出，非常凑巧，顺序恰好和把 <code>wait(0)</code> 放在父进程 <code>write</code> 之后那里的顺序一致：在父进程 <code>write</code> 之后等待子进程退出，这样能够保证父进程的 <code>write</code> 一定是由子进程的 <code>read</code> 消耗掉的，同时子进程 <code>write</code> 一个字节后直接执行结束，父进程就可以 <code>read</code> 到值了；</li>
<li>运气不好，遇到先运行父进程一直到 <code>wait</code> 调用而没来得及运行子进程的情况，就会出现这样的问题：子进程的 <code>read</code> 会一直阻塞，因为父进程的 <code>write</code> 被它自己的 <code>read</code> 给消耗掉了，此时没有谁来再给管道写入值了，再加上子进程还要给父进程 <code>write</code> 一个字节，所以它还不能在开头直接 <code>close(p[1]);</code>，<code>read</code> 返回的第二个条件也不满足，所以子进程的 <code>read</code> 会一直阻塞。</li>
</ul>
<p>问题解决。看似很小的问题，其实也有一点原子的味道，如果给 pipe 上锁，是不是就不会出现这个问题了？值得思考。</p>

            </article>
        <div class="my-4 w-full border-dashed border-t border-slate-300"></div>
            <div class="flex flex-col md:flex-row">
                <a class="inline my-1 py-2 px-4 font-bold text-slate-700 hover:underline"
                           href="/s3/3">
                            上一篇：
                            从 Happened-before 说起（1）
                        </a>
                    <a class="inline my-1 py-2 px-4 font-bold text-slate-700 hover:underline"
                           href="/s3/5">
                            下一篇：
                            xv6 学习记录
                        </a>
                    </div>
        </div>
    </main>
            <footer class="relative">
                <footer class="bg-black text-white text-center p-16">
    <div>
        <a href="https://github.com/whx828">Copyright © 2022-2023 whx</a>
    </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r121/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.waves.min.js"></script>
<script>
    document.getElementsByClassName('bg-primary')[0].setAttribute("id", "vanta");
    document.getElementById('vanta').classList.remove('bg-primary');
    window.addEventListener('DOMContentLoaded', () => {
        VANTA.WAVES({
            el: "#vanta",
            mouseControls: true,
            touchControls: true,
            gyroControls: false,
            minHeight: 200.00,
            minWidth: 200.00,
            scale: 1.00,
            scaleMobile: 1.00,
            shininess: 150.00,
            waveHeight: 37.50,
            waveSpeed: 1.50,
            zoom: 0.97
        })
    });
</script>
<script src="https://app.embed.im/snow.js" defer></script>
<style>
    .vanta {
        z-index: 0;
        position: relative;
        left: 0;
        right: 0;
        width: 100%;
        height: 100%;
    }

    @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC&display=swap');
</style><a href="https://github.com/zineland"
                   class="absolute z-20 bottom-0 w-full text-center font-bold md:text-slate-100 md:opacity-10 md:hover:opacity-50 md:bg-transparent bg-primary p-2 text-main">
                    Proudly powered by Zine.
                </a>
            </div>
        </footer>
    </body>
    <script src="/static/medium-zoom.min.js"></script>
    <script src="/static/zine.js"></script>
</html>
